{% extends "base.html" %}

{% block title %}Review Report #{{ report.id }} - Raportare Șantiere{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Raport #{{ report.id }}</h3>
                <div class="card-tools">
                    <a href="/validator" class="btn btn-sm btn-secondary">Înapoi</a>
                </div>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Tip:</dt>
                    <dd class="col-sm-9">
                        {% if session.get('role') == 'admin' %}
                        <select id="report-type" class="form-control form-control-sm d-inline-block" style="width: auto;">
                            <option value="no-paperwork" {% if report.type == 'no-paperwork' %}selected{% endif %}>Fără Acte</option>
                            <option value="noise-violation" {% if report.type == 'noise-violation' %}selected{% endif %}>Zgomot</option>
                            <option value="pollution-violation" {% if report.type == 'pollution-violation' %}selected{% endif %}>Poluare</option>
                            <option value="others" {% if report.type == 'others' %}selected{% endif %}>Altele</option>
                        </select>
                        <button class="btn btn-sm btn-success ml-2" onclick="updateType()">
                            <i class="fas fa-save"></i>
                        </button>
                        {% else %}
                        {% if report.type == 'no-paperwork' %}
                        <span class="badge badge-warning">Fără Acte</span>
                        {% elif report.type == 'noise-violation' %}
                        <span class="badge badge-secondary">Zgomot</span>
                        {% elif report.type == 'pollution-violation' %}
                        <span class="badge badge-info">Poluare</span>
                        {% elif report.type == 'others' %}
                        <span class="badge badge-dark">Altele</span>
                        {% else %}
                        <span class="badge badge-secondary">{{ report.type }}</span>
                        {% endif %}
                        {% endif %}
                    </dd>

                    <dt class="col-sm-3">Status:</dt>
                    <dd class="col-sm-9">
                        {% if report.status == 'pending' %}
                        <span class="badge badge-warning">Pending</span>
                        {% elif report.status == 'in-review' %}
                        <span class="badge badge-info">In Review</span>
                        {% elif report.status == 'validated' %}
                        <span class="badge badge-success">Validated</span>
                        {% elif report.status == 'resolved' %}
                        <span class="badge badge-primary">Resolved</span>
                        {% elif report.status == 'rejected' %}
                        <span class="badge badge-danger">Rejected</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-3">Data:</dt>
                    <dd class="col-sm-9">{{ report.created_at }}</dd>

                    <dt class="col-sm-3">Raportat de:</dt>
                    <dd class="col-sm-9">
                        {% if report.submitted_by_username %}
                        <span class="badge badge-info">
                            <i class="fas fa-user-shield"></i> {{ report.submitted_by_username }} (Official)
                        </span>
                        {% else %}
                        <span class="text-muted">Cetățean (Anonim)</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-3">Locație:</dt>
                    <dd class="col-sm-9">
                        {{ report.address or 'Lat: %.6f, Lng: %.6f'|format(report.location_lat, report.location_lng) }}
                    </dd>

                    <dt class="col-sm-3">Descriere:</dt>
                    <dd class="col-sm-9">
                        {% if session.get('role') == 'admin' %}
                        <textarea id="report-description" class="form-control" rows="3">{{ report.description or '' }}</textarea>
                        <button class="btn btn-sm btn-success mt-2" onclick="updateDescription()">
                            <i class="fas fa-save"></i> Salvează Descriere
                        </button>
                        {% else %}
                        {{ report.description or 'Fără descriere' }}
                        {% endif %}
                    </dd>
                </dl>

                <div id="map" style="height: 300px; margin-top: 20px;"></div>

                <h5 class="mt-4">Fotografii ({{ pictures|length }})</h5>
                <div class="row">
                    {% for picture in pictures %}
                    <div class="col-md-4 mb-3" id="picture-{{ loop.index }}">
                        <div class="position-relative">
                            <a href="{{ picture.url }}" target="_blank">
                                <img src="{{ picture.url }}" class="img-fluid img-thumbnail" alt="Poza {{ loop.index }}">
                            </a>
                            {% if session.get('role') == 'admin' %}
                            <button class="btn btn-danger btn-sm position-absolute"
                                    style="top: 5px; right: 20px;"
                                    onclick="deletePicture('{{ picture.path }}', 'picture-{{ loop.index }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="col-12">
                        <p class="text-muted">Nicio fotografie atașată</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h4>Comentarii</h4>
            </div>
            <div class="card-body">
                {% for comment in comments %}
                <div class="mb-3">
                    <strong>Admin</strong>
                    <small class="text-muted">{{ comment.created_at }}</small>
                    <p>{{ comment.text }}</p>
                </div>
                {% else %}
                <p class="text-muted">Niciun comentariu</p>
                {% endfor %}

                <form id="comment-form" class="mt-3">
                    <div class="form-group">
                        <label>Adaugă comentariu:</label>
                        <textarea class="form-control" name="content" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Adaugă Comentariu</button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h4>Acțiuni</h4>
            </div>
            <div class="card-body">
                <form id="status-form">
                    <div class="form-group">
                        <label>Schimbă Status:</label>
                        <select class="form-control" name="status">
                            <option value="pending" {% if report.status == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="in-review" {% if report.status == 'in-review' %}selected{% endif %}>In Review</option>
                            <option value="validated" {% if report.status == 'validated' %}selected{% endif %}>Validated</option>
                            <option value="rejected" {% if report.status == 'rejected' %}selected{% endif %}>Rejected</option>
                            <option value="resolved" {% if report.status == 'resolved' %}selected{% endif %}>Resolved</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">Actualizează Status</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize map
    var map = L.map('map').setView([{{ report.location_lat }}, {{ report.location_lng }}], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    L.marker([{{ report.location_lat }}, {{ report.location_lng }}]).addTo(map);

    // Status update
    $('#status-form').on('submit', function(e) {
        e.preventDefault();
        var status = $(this).find('select[name="status"]').val();

        $.ajax({
            url: '/validator/report/{{ report.id }}/status',
            type: 'POST',
            data: {status: status},
            success: function() {
                showSuccess('Status actualizat!', function() {
                    location.reload();
                });
            },
            error: function(xhr) {
                showError(xhr.responseJSON?.error || 'Eroare la actualizarea statusului');
            }
        });
    });

    // Comment submit
    $('#comment-form').on('submit', function(e) {
        e.preventDefault();
        var formData = $(this).serialize();

        $.ajax({
            url: '/validator/report/{{ report.id }}/comment',
            type: 'POST',
            data: formData,
            success: function() {
                showSuccess('Comentariu adăugat!', function() {
                    location.reload();
                });
            },
            error: function(xhr) {
                showError(xhr.responseJSON?.error || 'Eroare la adăugarea comentariului');
            }
        });
    });
});

// Admin functions
function updateType() {
    var newType = $('#report-type').val();
    $.ajax({
        url: '/admin/report/{{ report.id }}/update',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({type: newType}),
        success: function() {
            showSuccess('Tip actualizat!');
        },
        error: function(xhr) {
            showError(xhr.responseJSON?.error || 'Eroare la actualizarea tipului');
        }
    });
}

function updateDescription() {
    var newDesc = $('#report-description').val();
    $.ajax({
        url: '/admin/report/{{ report.id }}/update',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({description: newDesc}),
        success: function() {
            showSuccess('Descriere actualizată!');
        },
        error: function(xhr) {
            showError(xhr.responseJSON?.error || 'Eroare la actualizarea descrierii');
        }
    });
}

function deletePicture(storagePath, elementId) {
    showConfirm('Sigur vrei să ștergi această poză?', function() {
        $.ajax({
            url: '/admin/report/{{ report.id }}/picture/' + encodeURIComponent(storagePath) + '/delete',
            type: 'POST',
            success: function() {
                $('#' + elementId).fadeOut(300, function() {
                    $(this).remove();
                });
            },
            error: function(xhr) {
                showError(xhr.responseJSON?.error || 'Eroare la ștergerea pozei');
            }
        });
    });
}
</script>
{% endblock %}
